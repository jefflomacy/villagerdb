#!/usr/bin/env node

// Requirements.
const cron = require('node-cron');
const path = require('path');
const birthdays = require('../db/birthdays');
const siteMap = require('../helpers/sitemap');

// Now, start the scheduler.
scheduleCrons();

/**
 * Sets up all scheduled crons.
 */
function scheduleCrons() {
    // Clear birthdays cache every hour. We do it every hour because it's not very expensive and if something happens
    // where the server wasn't running at midnight, we'd like it to update anyway.
    cron.schedule('0 * * * *', () => {
        clearBirthdays();
    });

    cron.schedule('0 0 * * * *', () => {
        generateSitemaps();
    });
}

/**
 * Clears the birthday key in Redis so they get re-computed on next page load.
 */
function clearBirthdays() {
    console.log('Clearing birthdays...');
    birthdays.clearBirthdays()
        .then(() => {
            console.log('Cleared birthdays successfully.');
        })
        .catch((e) => {
            console.log('Unexpected exception while clearing birthdays.');
            console.error(e);
        });
}

/**
 * Generates a new site map in public/sitemaps.
 */
function generateSitemaps() {
    const dir = path.join('public', 'sitemaps');

    // Delete and re-create current sitemaps folder.
    siteMap.clearDirectory(dir);
    siteMap.createDirectory(dir);

    // Generate sitemaps and divide into properly sized files.
    siteMap.generateMaps();

}